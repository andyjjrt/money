<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/andyjjrt/money/master/book_icon6765.ico"/>
    <link rel="bookmark" href="https://raw.githubusercontent.com/andyjjrt/money/master/book_icon6765.ico">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e6faf8"/>
    <link rel="apple-touch-icon" sizes="192x192" href="https://raw.githubusercontent.com/andyjjrt/money/master/book_icon6765.ico"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <title>記帳</title>

  </head>
  <body  style="font-family:Microsoft JhengHei;">

    <nav class="navbar navbar-dark bg-dark">
        <div class="input-group-prepend ">
            <span class="navbar-brand mb-0 h1">記帳</span>
        </div>
    </nav>

    <div class="container">
        <br>
        <div class="clearfix">
          <h2>
            設定
          </h2>
          <a role="button" class="btn btn-primary float-right" href="https://github.com/andyjjrt/money/blob/master/README.md">前往教學</a>
        </div>
        <div class="form-group">
          <label>試算表id</label>
          <input type="text" class="form-control" id="datasrc">
        </div>
        <br>
        <div class="card">
          <div class="card-header ">
            <h5 id="tagtitle">
              &nbsp;標籤
              <button id="tagToggler1" class="btn btn-primary float-right" type="button" onclick="tagpage(this.id)">
                <svg width="1.6em" height="1.6em" viewBox="0 0 16 16" class="bi bi-plus-circle" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" d="M8 3.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z"/>
                  <path fill-rule="evenodd" d="M7.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8z"/>
                  <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                </svg>
              </button>
              <button id="tagToggler2" class="btn btn-primary float-right" type="button" onclick="tagpage(this.id)" style="display:none;">
                <svg width="1.6em" height="1.6em" viewBox="0 0 16 16" class="bi bi-x-square" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                  <path fill-rule="evenodd" d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
              </button>
            </h5>
          </div>
          <div class="card-body">
            <div class="tab-content" id="nav-tabContent">
              <div class="tab-pane fade show active col" id="tag-home" role="tabpanel" aria-labelledby="tag-home-tab">
              </div>
              <div class="tab-pane fade" id="tag-edit" role="tabpanel" aria-labelledby="tag-edit-tab">
                <form class="px-2 py-2"> 
                  <div class="form-group">
                    <label>標籤名稱</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="tagname">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>標籤顏色</label>
                    <div class="col-sm-10">
                      <input type="color" class="form-control" id="tagcolor">
                    </div>
                  </div>
                  <br>
                  <button class="btn btn-block btn-primary" onclick="create($('#tagname').val(),$('#tagcolor').val())">新增</button>
                </form>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn btn-block btn-success" onclick="updateTag()">更新到試算表</button>
          </div>
        </div>
    </div>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script>

      function generatePW(){
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }


      var pretag = []
      var pretagcolor = []
      var pretagid = []

      function tagpage(id){
        if(id == "tagToggler1"){
          $("#tagToggler1").attr("style","display:none;")
          $("#tagToggler2").attr("style","")
          $('#tag-edit').tab("show")
          $('#tag-home').attr("class","tab-pane fade")
        }else{
          $("#tagToggler1").attr("style","")
          $("#tagToggler2").attr("style","display:none;")
          $('#tag-home').tab("show")
          $('#tag-edit').attr("class","tab-pane fade")
        }
      }

      function create(tagName,tagColor){
        if(tagName == ""){
          alert("標籤名稱不可空白")
        }else{
          pretag.push(tagName)
          pretagcolor.push(tagColor)
          var pw = generatePW()
          pretagid.push(pw)
          $('#tag-home').append('<div class="btn btn-lg" role="button" onclick="del(\'' + pw + '\')" id="' + pw + '" style="background-color:' + tagColor + ';"><span class="badge badge-light">' + tagName + '</span></div>')
          tagpage("aaa")
        }
      }

      function del(a){
        var t = confirm("確定刪除?")
        if(t == true){
          $("#" + a).remove()
          var pos = pretagid.indexOf(a)
          pretagid.splice(pos, 1);
          pretag.splice(pos, 1);
          pretagcolor.splice(pos, 1);
        }
      }

      function updateTag(){
        //sw("loading","editp")
        if(pretag.length != 0){
          var data1txt=pretag[0],data2txt=pretagcolor[0],data3txt=pretagid[0];
          for(var i=1;i<pretag.length;i++){
            data1txt += "," + pretag[i]
            data2txt += "," + pretagcolor[i]
            data3txt += "," + pretagid[i]
          }
          var parameter={
            uid:"14xeLQsPjrD14YWaMBf4iMVnSYUH81jZpLOm-Drme_HQ",
            type:"write",
            data1:data1txt,
            data2:data2txt,
            data3:data3txt,
            length:pretag.length
          }
          $.ajax({ 
            type: "get", 
            url: "https://script.google.com/macros/s/AKfycbwB2zTpbCxg07uu6Fty1eTK5KyjPkCSiLlCs6ExYNeF_h6ZaKk/exec", 
            data: parameter, 
            dataType: "JSON", 
            success: function (response) {
              console.log(response);  
            } ,
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              //sw("oops","loading")
              //$("#errordisplay").html("<h4>錯誤位置:寫入階段<br>錯誤內容:" + XMLHttpRequest.responseText + "</h4>")
              //alert(XMLHttpRequest.responseText)
            }
          });
        }
      }

      $( document ).ready(function() {
        var parameter={
          uid:"14xeLQsPjrD14YWaMBf4iMVnSYUH81jZpLOm-Drme_HQ",
          type:"read",
        }
        $.ajax({ 
          type: "get", 
          url: "https://script.google.com/macros/s/AKfycbwB2zTpbCxg07uu6Fty1eTK5KyjPkCSiLlCs6ExYNeF_h6ZaKk/exec", 
          data: parameter, 
          dataType: "JSON", 
          success: function (response) {
            console.log(response);
            var tagamount = response[0].length
            pretag = response[0]
            pretagcolor = response[1]
            pretagid = response[2]
            for(var i=0;i<tagamount;i++){
              $('#tag-home').append('<div class="btn btn-lg" role="button" onclick="del(\'' + response[2][i] + '\')" id="' + response[2][i] + '" style="background-color:' + response[1][i] + ';"><span class="badge badge-light">' + response[0][i] + '</span></div>')
            }
          } ,
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            //sw("oops","loading")
            //$("#errordisplay").html("<h4>錯誤位置:寫入階段<br>錯誤內容:" + XMLHttpRequest.responseText + "</h4>")
            //alert(XMLHttpRequest.responseText)
          }
        });
      });
    </script>
  </body>
</html>